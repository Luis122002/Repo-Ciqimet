{% load static %}
<!DOCTYPE html>
{% include 'header.html' %}
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario General</title>
    <style>
        .container {
            margin-top: 30px;
        }
        .alert {
            margin-top: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-control {
            width: 100%;
            padding: 10px;
        }
        .btn-submit {
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1>Formulario General</h1>
        {% if form %}
            <form id="myForm" method="POST" action="Action-Resource/">
                {% csrf_token %}
                {% for field in form %}
                    <div class="form-group">
                        {{ field.label_tag }}
                        {{ field }}
                        {% if field.help_text %}
                            <small class="form-text text-muted">{{ field.help_text }}</small>
                        {% endif %}
                        {% if field.errors %}
                            <div class="alert alert-danger mt-2">
                                {{ field.errors }}
                            </div>
                        {% endif %}
                    </div>
                {% endfor %}
                <button type="submit" class="btn btn-primary btn-submit">Submit</button>
            </form>
            <br/>
            {% if id != "-1" %}
                <button class="btn btn-primary btn-alert" onclick='OnDeleteRegister()'>Borrar</button>
            {% endif %}
        {% else %}
            <div class="alert alert-warning" role="alert">
                No hay formulario disponible.
            </div>
        {% endif %}
        {% if message %}
            <div class="alert alert-danger" role="alert">
                {{ message }}
            </div>
        {% endif %}
        {% if success %}
            <div class="alert alert-success" role="alert">
                Acción realizada con éxito.
            </div>
        {% endif %}
    </div>
    <button id="open-alert">Crear Fórmula Química</button>
</body>
<script>
    var csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    document.getElementById('open-alert')?.addEventListener('click', function() {
        Swal.fire({
            title: 'Añadir Símbolo',
            html: `
                <div class="formula-editor">
                    <div class="editor-buttons">
                        <button onclick="addToFormula('¹')">¹</button>
                        <button onclick="addToFormula('²')">²</button>
                        <button onclick="addToFormula('³')">³</button>
                        <button onclick="addToFormula('⁴')">⁴</button>
                        <button onclick="addToFormula('⁵')">⁵</button>
                        <button onclick="addToFormula('⁶')">⁶</button>
                        <button onclick="addToFormula('⁷')">⁷</button>
                        <button onclick="addToFormula('⁸')">⁸</button>
                        <button onclick="addToFormula('⁹')">⁹</button>
                        <br/>
                        <button onclick="addToFormula('₁')">₁</button>
                        <button onclick="addToFormula('₂')">₂</button>
                        <button onclick="addToFormula('₃')">₃</button>
                        <button onclick="addToFormula('₄')">₄</button>
                        <button onclick="addToFormula('₅')">₅</button>
                        <button onclick="addToFormula('₆')">₆</button>
                        <button onclick="addToFormula('₇')">₇</button>
                        <button onclick="addToFormula('₈')">₈</button>
                        <button onclick="addToFormula('₉')">₉</button>
                    </div>
                    <div class="textarea-wrapper">
                        <textarea id="formula" class="swal2-textarea" placeholder="Ej. CO₂, H₂SO₄" rows="4"></textarea>
                    </div>
                </div>
            `,
            focusConfirm: false,
            preConfirm: () => {
                const formula = Swal.getPopup().querySelector('#formula').value;
                
                if (!formula) {
                    Swal.showValidationMessage('Por favor ingrese la fórmula');
                    return false;
                }
                
                return {
                    formula: formula
                }
            }
        }).then((result) => {
            if (result.isConfirmed) {
                const { formula } = result.value;
                const numeroElementoField = document.querySelector('input[name="numero_elemento"]');
                if (numeroElementoField) {
                    numeroElementoField.value = formula;
                }
                Swal.fire(`Fórmula química creada: ${formula}`);
            }
        });
    });

    function OnDeleteRegister() {
        Swal.fire({
            title: '¿Estás seguro que quieres eliminar este registro?',
            text: "Esta acción no se puede deshacer.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Eliminar',
            cancelButtonText: 'Cancelar',
            confirmButtonColor: '#d33', 
            cancelButtonColor: '#3085d6',
        }).then((result) => {
            if (result.isConfirmed) {
                const elementId = "{{ id }}";
                const urlDat = '/MasterData/';
                const Token = csrfToken;
                const context = "{{ contexModel }}"; 
                const action = 'del'; 
                const stade = "acces"; 
                $.ajax({
                    url: urlDat,
                    type: 'POST',
                    headers: {
                        'X-CSRFToken': Token
                    },
                    data: {
                        'id': elementId,
                        'context': context,
                        'action': action,
                        'stade': stade
                    },
                    success: function(response) {
                        if (response.redirect_url) {
                            window.location.href = response.redirect_url; 
                        } else {
                            console.log(response.message);
                        }
                    },
                    error: function(xhr) {
                        console.error('Error al enviar datos:', xhr.responseText);
                    }
                });
            } else if (result.dismiss === Swal.DismissReason.cancel) {
                Swal.fire(
                    'Cancelado',
                    'La eliminación ha sido cancelada.',
                    'info'
                );
            }
        }).catch(error => {
            Swal.fire(
                'Error',
                'Ocurrió un problema con la eliminación del registro.',
                'error'
            );
        });
    }
    

    function addToFormula(char) {
        const textarea = document.getElementById('formula');
        const cursorPos = textarea.selectionStart;
        const textBefore = textarea.value.substring(0, cursorPos);
        const textAfter = textarea.value.substring(cursorPos, textarea.value.length);
        
        textarea.value = textBefore + char + textAfter;
        textarea.focus();  // Opcional: enfoca el área de texto
        textarea.setSelectionRange(cursorPos + char.length, cursorPos + char.length); // Mueve el cursor
    }
</script>
</html>