{% load static %}
{% load custom_filters %}
<!DOCTYPE html>
{% include 'header.html'%}
{% csrf_token %}
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Absorción</title>
    <style>
        .actions, .details, .filters {
            margin: 0; /* Asegura que no haya márgenes adicionales */
            padding: 10px; /* Mantiene un espaciado interno uniforme */
            background-color: #f5f7fa; /* Color de fondo */
            border-radius: 8px; /* Bordes redondeados */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); /* Sombras ligeras */
            height: auto; /* Ajuste automático de altura */
        }

        .filters .btn {
            width: 100%; /* Hace que el botón ocupe todo el ancho del contenedor */
            display: block; /* Garantiza que sea un elemento de bloque */
            margin: 10px auto; /* Centra el botón vertical y horizontalmente */
        }
    
        .button-grid a {
            font-size: 12px;
            padding: 5px;
        }
    
        .data-grid {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 5px;
            margin: 5px 0;
        }
    
        .data-grid div {
            padding: 5px;
            background-color: #ffffff;
            text-align: center;
            border: 1px solid #ccc;
            border-radius: 4px;
            flex: 1 1 calc(30% - 10px);
            font-size: 12px;
        }
    
        .status-box {
            padding: 5px;
            background-color: #000;
            color: cyan;
            border: 1px solid #000;
            border-radius: 4px;
            font-size: 12px;
        }
    
        .status-box h6 {
            margin: 0;
            font-size: 12px;
        }
    
        .row.align-items-center {
            align-items: center; /* Asegura alineación vertical uniforme */
        }
    
        .buttons-row {
            display: flex;
            justify-content: center;
            gap: 5px;
        }
    
        .filters .input-group {
            display: flex;
            gap: 5px;
        }


        .row {
            margin: 0; /* Elimina márgenes adicionales entre filas */
            gap: 5px; /* Define un espacio uniforme de 5px entre columnas */
        }
        
        .col-md-3, .col-md-6 {
            padding: 5px; /* Añade un pequeño padding para un espaciado interno */
        }
        
        .btn-active {
            background-color: #007BFF; /* Color azul destacado */
            color: white;
            border-color: #0056b3;
        }

        .btn-normal {
            background-color: #cccccc;
            color: black;
            border: 1px solid #aaa;
            padding: 10px 20px;
            cursor: pointer;
            text-decoration: none;
            border-radius: 5px;
        }
        .btn:hover {
            background-color: #ddd;
        }
        .calibration-box {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            background-color: #f9f9f9;
            border-radius: 5px;
        }
    
        .calibration-box h6 {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 10px;
        }
    
        .form-control-sm {
            font-size: 12px;
            padding: 5px;
        }
    
    </style>
</head>
<body>
    <h1 class="custom-title">Puesto de Absorción</h1>

    <div class="row">
        <div class="col-md-3 actions">
            <h5 class="text-center">Acciones</h5>
            <div class="button-grid">
                <button class="btn btn-primary btn-sm w-100 mb-2" onclick="gestionarLotes()">Gestionar Lotes</button>
                <button class="btn btn-primary btn-sm w-100 mb-2" onclick="grabarLotes()">Grabar Lotes</button>
                <button class="btn btn-primary btn-sm w-100" onclick="exportarLotes()">Exportar</button>
                <a href="/index" class="btn btn-primary btn-sm w-100 mb-2">Atrás</a>
            </div>
        </div>
    
        <div class="col-md-6 details">
            <h5 class="text-center">Detalles</h5>
            <div class="data-grid">
                <div>Muestras: <span id="muestras">{{ muestras_count }}</span></div>
                <div>Blk Lab.: <span id="blk_lab">0</span></div>
                <div>Blk Prep.: <span id="blk_prep">0</span></div>
                <div>Dup. Lab.: <span id="dup_lab">0</span></div>
                <div>Dup. Prep.: <span id="dup_prep">0</span></div>
                <div>Std. Ref.: <span id="std_ref">0</span></div>
            </div>
            <div class="calibration-box">
                <div class="row align-items-center">
                    <div class="col-auto">
                        <p class="mb-0"><strong>Curv. Calibración:</strong></p>
                    </div>
                    <div class="col">
                        <div class="row">
                            <div class="col-3 mb-2">
                                <input type="text" class="form-control form-control-sm" id="curv-1" 
                                       placeholder="Curv. 1" 
                                       oninput="validateDecimal(this)"
                                       value="{{ curvaturas.curv_1 }}" data-curvatura-id="1">
                            </div>
                            <div class="col-3 mb-2">
                                <input type="text" class="form-control form-control-sm" id="curv-2" 
                                       placeholder="Curv. 2" 
                                       oninput="validateDecimal(this)"
                                       value="{{ curvaturas.curv_2 }}" data-curvatura-id="2">
                            </div>
                            <div class="col-3">
                                <input type="text" class="form-control form-control-sm" id="curv-3" 
                                       placeholder="Curv. 3" 
                                       oninput="validateDecimal(this)"
                                       value="{{ curvaturas.curv_3 }}" data-curvatura-id="3">
                            </div>
                            <div class="col-3">
                                <input type="text" class="form-control form-control-sm" id="curv-4" 
                                       placeholder="Curv. 4" 
                                       oninput="validateDecimal(this)"
                                       value="{{ curvaturas.curv_4 }}" data-curvatura-id="4">
                            </div>                            
                            <button class="btn btn-primary mt-3" onclick="guardarValoresAbsorcion(contexto)">Guardar Valores</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="buttons-row mt-2 d-flex justify-content-center">
                <button class="btn btn-active" onclick="mostrarTabla('hojaTrabajo', this, 0)">Hoja de trabajo</button>
                <button class="btn btn-norma" onclick="mostrarTabla('diluciones', this, 1)">Diluciones</button>
                <button class="btn btn-norma" onclick="mostrarTabla('lecturas', this, 2)">Lecturas</button>
                <button class="btn btn-norma" onclick="mostrarTabla('leyes', this, 3)">Leyes</button>
            </div>
        </div>
    
        <!-- Columna de filtros -->
        <!-- Columna de filtros -->
        <div class="col-md-3 filters">
            <h5 class="text-center">Filtros</h5>
            <div class="input-group mb-2">
                <button class="btn btn-primary btn-sm" id="buscarHojasBtn">Buscar hojas</button>
            </div>
            <div class="status-box text-center">
                <h6>Id. de Lote</h6>
                <p>
                    {% if Batch_ID %}
                        {{ Batch_ID }}
                    {% else %}
                        Sin Asig.
                    {% endif %}
                </p>
                <p>
                    Creación: 
                    <span id="fecha_creacion">
                        {% if Bacth_Creación %}
                            {{ Bacth_Creación|date:"d/m/Y" }}
                        {% else %}
                            Sin fecha
                        {% endif %}
                    </span>
                </p>
                <div id="idHdtContainer" style="color: #00FFFF; text-align: center; margin-top: 10px;">
                    <h6>HDT's:</h6> <!-- Título añadido -->
                    <div style="display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                        {% for id in id_hdt %}
                        <div name="id_hdt_value" style="padding: 2px 5px; border: none; background-color: transparent; color: #00FFFF;">
                            {{ id }}
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>


    <div id="hojaTrabajo" class="tabla">
        <div class="table-container table-responsive">
            <table class="table table-bordered">
                <thead style="background-color: #002d72; color: rgb(255, 255, 255);">
                    <tr>
                        <th scope="col">Orden</th>
                        <th scope="col">Id de muestra</th>
                        <th scope="col">Tipo</th>
                        <th scope="col">Peso (gr)</th>
                        <th scope="col">Volumen (ml)</th>
                        <th scope="col">Hoja de trabajo</th>
                        <th scope="col">Cliente</th>
                    </tr>
                </thead>
                <tbody>
                    {% for ht in Doc_Muestra %}
                    <tr data-ht-id="{{ ht.ID_HDT }}">
                        <td>{{ forloop.counter }}</td>
                        <td>{{ ht.Prefijo }}</td>
                        <td>{{ ht.HojaTrabajo.Tipo }}</td>
                        <td>{{ ht.Peso }}</td>
                        <td>{{ ht.Volumen }}</td>
                        <td>{{ ht.HojaTrabajo.ID_HDT }}</td>
                        <td>{{ ht.HojaTrabajo.Cliente }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>          
        </div>
    </div>
    
    <div id="diluciones" class="tabla hidden">
        {% if batch_mode %}
            <div class="table-container table-responsive">
                <table class="table table-bordered">
                    <thead style="background-color: #002d72; color: rgb(255, 255, 255);">
                        <tr>
                            <th scope="col">Orden</th>
                            <th scope="col">Id de muestra</th>
                            <th scope="col">Tipo</th>
                            <th scope="col">Hoja de trabajo</th>
                            <th scope="col">Cliente</th>
                            {% for elemento in elementos_unicos %}
                                <th scope="col">Fact. Dil {{ elemento }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for ht in Doc_Muestra %}
                            <tr>
                                <td>{{ forloop.counter }}</td>
                                <td>{{ ht.Prefijo }}</td>
                                <td>{{ ht.HojaTrabajo.Tipo }}</td>
                                <td>{{ ht.HojaTrabajo.ID_HDT }}</td>
                                <td>{{ ht.HojaTrabajo.Cliente }}</td>
                                {% for elemento in elementos_unicos %}
                                    {% with resultado=ht.Elementos|get_item:elemento %}
                                        <td>
                                            {% if resultado %}
                                                <input type="text"
                                                       oninput="validateDecimal(this)" 
                                                       onkeydown="moverFoco(event)"
                                                       class="form-control form-control-sm dilucion-input" 
                                                       name="dilucion_{{ resultado.resultado_id }}" 
                                                       data-resultado-id="{{ resultado.resultado_id }}" 
                                                       data-muestra-id="{{ ht.Prefijo }}" 
                                                       placeholder="Dilución" 
                                                       value="{{ resultado.dilucion }}">
                                            {% else %}
                                                <span></span> <!-- Campo vacío -->
                                            {% endif %}
                                        </td>
                                    {% endwith %}
                                {% endfor %}
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="table-container table-responsive">
                <h3>No hay resultados disponibles para las muestras del lote cargado.</h3>
            </div>
        {% endif %}
    </div>
    
    
    <div id="lecturas" class="tabla hidden">
        {% if batch_mode %}
        <div class="table-container table-responsive">
            <table class="table table-bordered">
                <thead style="background-color: #002d72; color: rgb(255, 255, 255);">
                    <tr>
                        <th scope="col">Orden</th>
                        <th scope="col">Id de muestra</th>
                        <th scope="col">Tipo</th>
                        <th scope="col">Hoja de trabajo</th>
                        <th scope="col">Cliente</th>
                        {% for elemento in elementos_unicos %}
                            <th scope="col">Lectura {{ elemento }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for ht in Doc_Muestra %}
                        <tr>
                            <td>{{ forloop.counter }}</td>
                            <td>{{ ht.Prefijo }}</td>
                            <td>{{ ht.HojaTrabajo.Tipo }}</td>
                            <td>{{ ht.HojaTrabajo.ID_HDT }}</td>
                            <td>{{ ht.HojaTrabajo.Cliente }}</td>
                            {% for elemento in elementos_unicos %}
                                {% with resultado=ht.Elementos|get_item:elemento %}
                                    <td>
                                        {% if resultado %}
                                            <input type="text" oninput="validateDecimal(this)" onkeydown="moverFoco(event)"
                                                   class="form-control form-control-sm lectura-input"
                                                   name="lectura_{{ resultado.resultado_id }}"
                                                   data-resultado-id="{{ resultado.resultado_id }}"
                                                   data-muestra-id="{{ ht.Prefijo }}"
                                                   value="{{ resultado.resultadoAnalisis }}">
                                        {% else %}
                                            <span></span>
                                        {% endif %}
                                    </td>
                                {% endwith %}
                            {% endfor %}
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        
        
        {% else %}
            <div class="table-container table-responsive">
                <h3>No hay resultados disponibles para las muestras del lote cargado.</h3>
            </div>
        {% endif %}
    </div>

    
    <div id="leyes" class="tabla hidden">
        {% if batch_mode %}
            <div class="table-container table-responsive">
                <table class="table table-bordered">
                    <thead style="background-color: #002d72; color: rgb(255, 255, 255);">
                        <tr>
                            <th scope="col">Orden</th>
                            <th scope="col">Id de muestra</th>
                            <th scope="col">Tipo</th>
                            <th scope="col">Hoja de trabajo</th>
                            <th scope="col">Cliente</th>
                            {% for elemento in elementos_unicos %}
                                <th scope="col">Ley {{ elemento }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for ht in Doc_Muestra %}
                            <tr>
                                <td>{{ forloop.counter }}</td>
                                <td>{{ ht.Prefijo }}</td>
                                <td>{{ ht.HojaTrabajo.Tipo }}</td>
                                <td>{{ ht.HojaTrabajo.ID_HDT }}</td>
                                <td>{{ ht.HojaTrabajo.Cliente }}</td>
                                {% for elemento in elementos_unicos %}
                                    {% with resultado=ht.Elementos|get_item:elemento %}
                                        <td>
                                            {% if resultado %}
                                                <input type="text"
                                                       oninput="validateDecimal(this)" 
                                                       onkeydown="moverFoco(event)"
                                                       class="form-control form-control-sm ley-input" 
                                                       name="ley_{{ resultado.resultado_id }}" 
                                                       data-resultado-id="{{ resultado.resultado_id }}" 
                                                       data-muestra-id="{{ ht.Prefijo }}"
                                                       placeholder="Ley" 
                                                       value="{{ resultado.leyAnalisis }}">
                                            {% else %}
                                                <span></span> <!-- Campo vacío -->
                                            {% endif %}
                                        </td>
                                    {% endwith %}
                                {% endfor %}
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="table-container table-responsive">
                <h3>No hay resultados disponibles para las muestras del lote cargado.</h3>
            </div>
        {% endif %}
    </div>
    
    <script>

        var csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        let inputContex = 1;

        document.addEventListener('DOMContentLoaded', function () {
            const rows = document.querySelectorAll('tbody tr');
            rows.forEach(row => {
                row.addEventListener('click', function () {
                    const odtId = this.getAttribute('data-odt-id');
                    if (odtId) {
                        const form = document.createElement('form');
                        form.method = 'POST';
                        form.action = '/ODT-info/';
                        form.style.display = 'none'; 
                        form.innerHTML = `<input type="hidden" name="odt_id" value="${odtId}">
                                            <input type="hidden" name="csrfmiddlewaretoken" value="${csrfToken}">`;
                        document.body.appendChild(form);
                        form.submit();
                    }
                });
            });
        });

     
        function mostrarTabla(id, boton, c) {
            contexto = c;
            document.querySelectorAll('.tabla').forEach(function(tabla) {
                tabla.classList.add('hidden');
            });
        
            document.getElementById(id).classList.remove('hidden');
        
            document.querySelectorAll('.btn').forEach(function(btn) {
                btn.classList.remove('btn-active');
            });
        
            boton.classList.add('btn-active');
        }
        

        function AddODT()
        {
            const elementId = -1;
            const urlDat = '/MasterData/';
            const Token = csrfToken;
            const context = 'ODT'; 
            const action = 'add'; 
            const stade = "acces"; 
            $.ajax({
                url: urlDat,
                type: 'POST',
                headers: {
                    'X-CSRFToken': Token
                },
                data: {
                    'id': elementId,
                    'context': context,
                    'action': action,
                    'stade': stade
                },
                success: function(response) {
                    if (response.redirect_url) {
                        window.location.href = response.redirect_url; 
                    } else {
                        console.log(response.message);
                    }
                },
                error: function(xhr) {
                    console.error('Error al enviar datos:', xhr.responseText);
                }
            });
        }

        function applyFilters() {
            var year = document.getElementById('filter-year').value;
            var month = document.getElementById('filter-month').value;
            var search = document.getElementById('search-box').value;
        
            var url = new URL(window.location.href);
            url.searchParams.set('year', year);
            url.searchParams.set('month', month);
            url.searchParams.set('search', search);
            window.location.href = url.toString();
        }

        function validateDecimal(input) {
            let value = input.value;
            let filteredValue = "";
            let commaCount = 0; 
        
            for (let i = 0; i < value.length; i++) {
                const char = value[i];
        
                if ("0123456789".includes(char)) {
                    filteredValue += char;
                } else if (char === "," && commaCount === 0) {
                    filteredValue += char;
                    commaCount++;
                }
            }
        
            if (filteredValue.length > 10) {
                filteredValue = filteredValue.slice(0, 10);
            }
            input.value = filteredValue;
        }

        document.getElementById('buscarHojasBtn').addEventListener('click', function() {
            // Mostrar mensaje de carga
            Swal.fire({
                title: 'Cargando...',
                text: 'Por favor espera mientras procesamos la solicitud.',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
        
            // Realizar la petición GET para obtener los datos
            fetch('/obtener-hojas/', {
                method: 'GET'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error en la solicitud');
                }
                return response.json();
            })
            .then(data => {
                Swal.close();
        
                if (data.hojas && data.hojas.length > 0) {
                    // Crear el contenido de la tabla con buscador y el input de selección
                    const htmlContent = `
                        <input type="text" id="buscarHojasInput" placeholder="Buscar hoja de trabajo..." class="form-control mb-3" onkeyup="filtrarTabla()">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>ID Hoja de Trabajo</th>
                                </tr>
                            </thead>
                            <tbody id="tablaHojas">
                                ${data.hojas.map((hoja, index) => `
                                    <tr onclick="seleccionarFila(this)" data-id="${hoja}">
                                        <td>${index + 1}</td>
                                        <td>${hoja}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        <div class="mt-3">
                            <label for="hojaSeleccionada">Hoja seleccionada:</label>
                            <input type="text" id="hojaSeleccionada" class="form-control mb-3" readonly placeholder="Selecciona un valor de la tabla">
                            <button class="btn btn-primary" onclick="usarHojaTrabajo()">Usar Hoja de Trabajo</button>
                            <button class="btn btn-primary" onclick="AgregarHojaTrabajo()">Agregar Hoja de Trabajo</button>

                        </div>
                    `;
        
                    // Mostrar SweetAlert2 con la tabla, input y botón
                    Swal.fire({
                        title: 'Selecciona una Hoja de Trabajo',
                        html: htmlContent,
                        showConfirmButton: false,
                        width: '600px',
                        scrollbarPadding: false,
                    });
                } else {
                    Swal.fire({
                        title: 'Sin Resultados',
                        text: 'No se encontraron hojas de trabajo con los criterios especificados.',
                        icon: 'info',
                        confirmButtonText: 'Cerrar'
                    });
                }
            })
            .catch(error => {
                Swal.fire({
                    title: 'Error',
                    text: 'Hubo un problema al procesar la solicitud. Intenta nuevamente.',
                    icon: 'error',
                    confirmButtonText: 'Cerrar'
                });
            });
        });
        
        function filtrarTabla() {
            const input = document.getElementById('buscarHojasInput');
            const filter = input.value.toLowerCase();
            const rows = document.querySelectorAll('#tablaHojas tr');
        
            rows.forEach(row => {
                const cell = row.cells[1];
                if (cell && cell.textContent.toLowerCase().includes(filter)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        let hojaSeleccionada = null;
        
        function seleccionarFila(fila) {
            const filas = document.querySelectorAll('#tablaHojas tr');
            filas.forEach(f => f.classList.remove('table-active'));
        
            fila.classList.add('table-active');
            hojaSeleccionada = fila.dataset.id;
        
            document.getElementById('hojaSeleccionada').value = hojaSeleccionada;
        }
        
        function usarHojaTrabajo() {
            if (!hojaSeleccionada) {
                Swal.fire({
                    title: 'Sin Selección',
                    text: 'No se ha seleccionado una hoja de trabajo para abrir.',
                    icon: 'warning',
                    confirmButtonText: 'Cerrar'
                });
                return;
            }
        
            const csrfToken = '{{ csrf_token }}'; 
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/Puesto-Absorcion/';
        
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = csrfToken;
            form.appendChild(csrfInput);
        
            const idInput = document.createElement('input');
            idInput.type = 'hidden';
            idInput.name = 'id';
            idInput.value = hojaSeleccionada;
            form.appendChild(idInput);
        
            document.body.appendChild(form);
            form.submit();
        }


        function AgregarHojaTrabajo() {
            if (!hojaSeleccionada) {
                Swal.fire({
                    title: 'Sin Selección',
                    text: 'No se ha seleccionado una hoja de trabajo para añadir.',
                    icon: 'warning',
                    confirmButtonText: 'Cerrar'
                });
                return;
            }
        
            const elementos = document.querySelectorAll('[name="id_hdt_value"]');
            const idHdtList = [];
            for (let i = 0; i < elementos.length; i++) {
                const valor = elementos[i].textContent.trim();
                idHdtList.push(valor);
            }
        
            const idHdtConcatenado = idHdtList.join('-');
        
            const csrfToken = '{{ csrf_token }}';
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/Puesto-Absorcion/';
        
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = csrfToken;
            form.appendChild(csrfInput);
        
            const idInput = document.createElement('input');
            idInput.type = 'hidden';
            idInput.name = 'id';
            idInput.value = hojaSeleccionada; 
            form.appendChild(idInput);
        
            const idSecInput = document.createElement('input');
            idSecInput.type = 'hidden';
            idSecInput.name = 'id_sec';
            idSecInput.value = idHdtConcatenado;
            form.appendChild(idSecInput);
        
            console.log("Lista acumulativa concatenada:", idSecInput.value);
            console.log("ID seleccionado:", idInput.value);
        
            document.body.appendChild(form);
            form.submit();
        }


        function AccederLote(id_Lot) {

            console.log(id_Lot)
            if (!id_Lot) {
                Swal.fire({
                    title: 'Sin Selección',
                    text: 'No se ha seleccionado lote de trabajo para abrir.',
                    icon: 'warning',
                    confirmButtonText: 'Cerrar'
                });
                return;
            }
        
            const csrfToken = '{{ csrf_token }}'; 
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/Puesto-Absorcion/';
        
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = csrfToken;
            form.appendChild(csrfInput);
        
            const idInput = document.createElement('input');
            idInput.type = 'hidden';
            idInput.name = 'batch';
            idInput.value = id_Lot;
            form.appendChild(idInput);
        
            document.body.appendChild(form);
            form.submit();
        }

        function grabarLotes() {
            Swal.fire({
                title: '¿Estás seguro?',
                text: '¿Deseas generar un nuevo lote?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Aplicar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Obtener la lista de ID de hojas de trabajo concatenadas
                    const elementos = document.querySelectorAll('[name="id_hdt_value"]');
                    const idHdtList = [];
                    for (let i = 0; i < elementos.length; i++) {
                        const valor = elementos[i].textContent.trim();
                        idHdtList.push(valor);
                    }
                    const idHdtConcatenado = idHdtList.join('-');
        
                    // Mostrar el mensaje de carga mientras se procesa
                    Swal.fire({
                        title: 'Generando Lote...',
                        text: 'Por favor espera mientras se genera el nuevo lote.',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });
                    fetch('/lot-generator/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify({ id: idHdtConcatenado }),
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Error en la solicitud');
                        }
                        return response.json();
                    })
                    .then(data => {
                        Swal.close();
        
                        if (data.success) {
                            Swal.fire({
                                title: 'Lote Generado',
                                html: `<p>El nuevo lote se generó correctamente con el ID:</p>
                                       <h3>${data.generated_lot_id}</h3>`,
                                icon: 'success',
                                showCancelButton: true,
                                confirmButtonText: 'Abrir Lote',
                                cancelButtonText: 'Cerrar'
                            }).then((openResult) => {
                                if (openResult.isConfirmed) {
                                    AccederLote(data.generated_lot_id);
                                }
                            });
                        } else {
                            Swal.fire({
                                title: 'Error',
                                text: data.error || 'Hubo un problema al generar el lote.',
                                icon: 'error',
                                confirmButtonText: 'Cerrar'
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        Swal.fire({
                            title: 'Error',
                            text: 'Hubo un problema al procesar la solicitud. Intenta nuevamente.',
                            icon: 'error',
                            confirmButtonText: 'Cerrar'
                        });
                    });
                } else {
                    Swal.fire({
                        title: 'Acción cancelada',
                        text: 'No se realizó ningún cambio.',
                        icon: 'info',
                        confirmButtonText: 'Cerrar'
                    });
                }
            });
        }
        
        function gestionarLotes() {
            // Mostrar mensaje de carga mientras se realiza la solicitud
            Swal.fire({
                title: 'Cargando Lotes...',
                text: 'Por favor espera mientras obtenemos la lista de lotes.',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
        
            // Realizar la solicitud AJAX
            fetch('/get-lotes/', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error en la solicitud');
                    }
                    return response.json();
                })
                .then(data => {
                    Swal.close();
        
                    if (data.lotes && data.lotes.length > 0) {
                        // Generar contenido HTML para la tabla
                        const htmlContent = `
                            <input type="text" id="buscarLotesInput" placeholder="Buscar lote..." class="form-control mb-3" onkeyup="filtrarTablaLotes()">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>ID Lote</th>
                                        <th>Acción</th>
                                    </tr>
                                </thead>
                                <tbody id="tablaLotes">
                                    ${data.lotes.map((lote, index) => `
                                        <tr>
                                            <td>${index + 1}</td>
                                            <td>${lote.id}</td>
                                            <td>
                                                <button class="btn btn-primary btn-sm" onclick="AccederLote('${lote.id}')">Acceder Lote</button>
                                                <button class="btn btn-danger btn-sm" onclick="eliminarLote('${lote.id}')">Eliminar</button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        `;
        
                        // Mostrar la tabla en un SweetAlert2
                        Swal.fire({
                            title: 'Gestionar Lotes',
                            html: htmlContent,
                            showConfirmButton: false,
                            width: '600px',
                            scrollbarPadding: false,
                        });
                    } else {
                        Swal.fire({
                            title: 'Sin Resultados',
                            text: 'No se encontraron lotes.',
                            icon: 'info',
                            confirmButtonText: 'Cerrar'
                        });
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    Swal.fire({
                        title: 'Error',
                        text: 'Hubo un problema al procesar la solicitud. Intenta nuevamente.',
                        icon: 'error',
                        confirmButtonText: 'Cerrar'
                    });
                });
        }

        function eliminarLote(loteId) {
            Swal.fire({
                title: '¿Estás seguro?',
                text: `¿Deseas eliminar el lote ${loteId}? Esta acción no se puede deshacer.`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Eliminar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch('/delete-lote/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify({ lote_id: loteId })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire({
                                title: 'Eliminado',
                                text: data.message,
                                icon: 'success',
                                confirmButtonText: 'Cerrar'
                            }).then(() => {
                                window.location.href = window.location.href;
                            });
                        } else {
                            Swal.fire({
                                title: 'Error',
                                text: data.error || 'Hubo un problema al eliminar el lote.',
                                icon: 'error',
                                confirmButtonText: 'Cerrar'
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        Swal.fire({
                            title: 'Error',
                            text: 'Hubo un problema al procesar la solicitud.',
                            icon: 'error',
                            confirmButtonText: 'Cerrar'
                        });
                    });
                }
            });
        }
        
        // Función para filtrar la tabla de lotes
        function filtrarTablaLotes() {
            const input = document.getElementById('buscarLotesInput');
            const filter = input.value.toLowerCase();
            const rows = document.querySelectorAll('#tablaLotes tr');
        
            rows.forEach(row => {
                const cell = row.cells[1];
                if (cell && cell.textContent.toLowerCase().includes(filter)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
    

        function guardarValoresAbsorcion(contexto) {
            let inputClass;
            let tipoMensaje = ""; // Para determinar el mensaje final según el contexto
        
            if (contexto === 1) {
                inputClass = '.dilucion-input';
                tipoMensaje = "diluciones";
            } else if (contexto === 2) {
                inputClass = '.lectura-input';
                tipoMensaje = "lecturas";
            } else if (contexto === 3) {
                inputClass = '.ley-input';
                tipoMensaje = "leyes";
            } else {
                console.error('Contexto no válido');
                return;
            }
        
            // Obtener los inputs de acuerdo al contexto
            const inputs = document.querySelectorAll(`${inputClass}:not([disabled])`);
            const datos = Array.from(inputs).map(input => ({
                resultado_id: input.dataset.resultadoId,
                muestra_id: input.dataset.muestraId,
                valor: input.value.replace(',', '.')
            }));
        
            // Obtener las curvaturas independientemente del contexto
            const curvaturas = Array.from(document.querySelectorAll('[id^="curv-"]')).map(input => ({
                curv_id: input.id.split('-')[1],
                valor: input.value.replace(',', '.')
            }));
        
            const payload = {
                datos,
                contexto,
                curvaturas
            };
        
            // Realizar el fetch
            fetch('/guardar-valores-absorcion/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify(payload)
            })
            .then(response => {
                if (!response.ok) throw new Error('Error en la solicitud');
                return response.json();
            })
            .then(data => {
                Swal.fire({
                    title: 'Éxito',
                    text: `Se han guardado correctamente los valores de ${tipoMensaje} y curvaturas.`,
                    icon: 'success',
                    confirmButtonText: 'Cerrar'
                });
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    title: 'Error',
                    text: 'Hubo un problema al guardar los valores. Intenta nuevamente.',
                    icon: 'error',
                    confirmButtonText: 'Cerrar'
                });
            });
        }


        function exportarTablaSeleccionada(formato, incluirHeader, tablaId) {
            const tabla = document.getElementById(tablaId);
            if (!tabla) {
                Swal.fire('Error', 'No se encontró la tabla seleccionada.', 'error');
                return;
            }
        
            let contenido = '';
            const filas = tabla.querySelectorAll('tr');
        
            filas.forEach((fila, index) => {
                const celdas = fila.querySelectorAll('th, td');
                const valores = Array.from(celdas).map(celda => {
                    const input = celda.querySelector('input');
                    if (input) {
                        return input.value.trim();
                    }
                    let texto = celda.textContent.trim();
                    if (formato === 'csv') texto = `"${texto}"`; // Escapar texto con comillas dobles
                    return texto;
                });
        
                if (index === 0 && !incluirHeader && fila.querySelector('th')) return; // Saltar encabezado
        
                contenido += valores.join(formato === 'csv' ? ';' : ' | ') + '\r\n'; // Separador para CSV y TXT
            });
        
            descargarArchivo(contenido, document.getElementById('export_name').value, formato);
        }
        
        function exportarLotes() {
            Swal.fire({
                title: 'Exportar Datos',
                html: `
                    <div>
                        <p>Selecciona la tabla a exportar:</p>
                        <button class="btn btn-primary w-100 mb-2" data-target="hojaTrabajo" onclick="activarBotonTabla(this)">Hoja de Trabajo</button>
                        <button class="btn btn-primary w-100 mb-2" data-target="diluciones" onclick="activarBotonTabla(this)">Diluciones</button>
                        <button class="btn btn-primary w-100 mb-2" data-target="lecturas" onclick="activarBotonTabla(this)">Lecturas</button>
                        <button class="btn btn-primary w-100 mb-2" data-target="leyes" onclick="activarBotonTabla(this)">Leyes</button>
                    </div>
                    <div>
                        <p>Formato de Exportación:</p>
                        <div>
                            <input type="radio" id="formato_csv" name="formato" value="csv" checked>
                            <label for="formato_csv">CSV</label>
                            <input type="radio" id="formato_txt" name="formato" value="txt">
                            <label for="formato_txt">TXT</label>
                        </div>
                    </div>
                    <div>
                        <input type="checkbox" id="incluir_header" name="incluir_header" checked>
                        <label for="incluir_header">Incluir encabezados</label>
                    </div>
                    <div>
                        <label for="export_name">Nombre del archivo:</label>
                        <input type="text" id="export_name" value="documento_export" readonly>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: 'Exportar',
                cancelButtonText: 'Cancelar',
                preConfirm: () => {
                    const formato = document.querySelector('input[name="formato"]:checked').value;
                    const incluirHeader = document.getElementById('incluir_header').checked;
                    const activeButton = document.querySelector('.btn-active');
                    const tableId = activeButton ? activeButton.getAttribute('data-target') : null;
                    return { formato, incluirHeader, tableId };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const { formato, incluirHeader, tableId } = result.value;
                    if (!tableId) {
                        Swal.fire('Error', 'No se seleccionó ninguna tabla para exportar.', 'error');
                        return;
                    }
                    exportarTablaSeleccionada(formato, incluirHeader, tableId);
                }
            });
        }
        
        function activarBotonTabla(boton) {
            document.querySelectorAll('.btn').forEach(btn => btn.classList.remove('btn-active'));
            boton.classList.add('btn-active');
        }
        
        function descargarArchivo(contenido, nombre, formato) {
            const blob = new Blob([contenido], { type: formato === 'csv' ? 'text/csv;charset=utf-8;' : 'text/plain;charset=utf-8;' });
            const enlace = document.createElement('a');
            enlace.href = URL.createObjectURL(blob);
            enlace.download = `${nombre}.${formato}`;
            enlace.click();
        }
    
        
    </script>
</body>
{% include 'Footer.html' %}
</html>
